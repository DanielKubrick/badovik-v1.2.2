'use client'

import { useState, useEffect } from "react";
import { useRouter } from "next/navigation";
import { ArrowLeft, User, Phone, Mail, CreditCard, ShoppingBag, CheckCircle } from "lucide-react";
import { useCart } from "../../components/cart/store";
import { useToastSuccess, useToastError, useToastWarning } from "@/components/ui/ToastContainer";
import LoadingSpinner from "@/components/ui/LoadingSpinner";

const formatPrice = (price: number): string => {
  if (price === 0) return '–£—Ç–æ—á–Ω–∏—Ç—å —Ü–µ–Ω—É';
  return new Intl.NumberFormat('ru-RU', {
    style: 'currency',
    currency: 'RUB',
    minimumFractionDigits: 0,
    maximumFractionDigits: 2,
  }).format(price).replace('‚ÇΩ', '').trim() + ' ‚ÇΩ';
};

export default function CheckoutPage() {
  const router = useRouter();
  const cart = useCart();
  const toastSuccess = useToastSuccess();
  const toastError = useToastError();
  const toastWarning = useToastWarning();

  const [billingData, setBillingData] = useState({
    firstName: '',
    lastName: '',
    phone: '',
    email: ''
  });
  const [formErrors, setFormErrors] = useState<Record<string, string>>({});
  const [currentStep, setCurrentStep] = useState(1);

  const items = Object.values(cart.items);
  const totalCount = cart.count();
  const totalPrice = cart.total();

  useEffect(() => {
    // –ï—Å–ª–∏ –∫–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞, –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ –≥–ª–∞–≤–Ω—É—é
    if (items.length === 0) {
      toastWarning('–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞', '–î–æ–±–∞–≤—å—Ç–µ —Ç–æ–≤–∞—Ä—ã –¥–ª—è –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞');
      router.push('/');
    }
  }, [items.length, router, toastWarning]);

  const validateForm = () => {
    const errors: Record<string, string> = {};
    
    if (!billingData.firstName.trim()) {
      errors.firstName = '–ò–º—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è';
    } else if (billingData.firstName.length < 2) {
      errors.firstName = '–ò–º—è –¥–æ–ª–∂–Ω–æ —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 2 —Å–∏–º–≤–æ–ª–∞';
    }
    
    if (!billingData.lastName.trim()) {
      errors.lastName = '–§–∞–º–∏–ª–∏—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞ –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è';
    } else if (billingData.lastName.length < 2) {
      errors.lastName = '–§–∞–º–∏–ª–∏—è –¥–æ–ª–∂–Ω–∞ —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 2 —Å–∏–º–≤–æ–ª–∞';
    }
    
    if (billingData.phone && !/^\+?[1-9]\d{1,14}$/.test(billingData.phone.replace(/[\s\-\(\)]/g, ''))) {
      errors.phone = '–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞';
    }
    
    if (billingData.email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(billingData.email)) {
      errors.email = '–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç email –∞–¥—Ä–µ—Å–∞';
    }
    
    setFormErrors(errors);
    return Object.keys(errors).length === 0;
  };

  const handleInputChange = (field: string, value: string) => {
    setBillingData(prev => ({...prev, [field]: value}));
    // –û—á–∏—â–∞–µ–º –æ—à–∏–±–∫—É –¥–ª—è –ø–æ–ª—è –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏
    if (formErrors[field]) {
      setFormErrors(prev => {
        const newErrors = {...prev};
        delete newErrors[field];
        return newErrors;
      });
    }
  };

  const handleNextStep = () => {
    if (currentStep === 1) {
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–ª—è
      if (billingData.firstName.trim() && billingData.lastName.trim()) {
        setCurrentStep(2);
        toastSuccess('–û—Ç–ª–∏—á–Ω–æ!', '–ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –∫–æ–Ω—Ç–∞–∫—Ç–Ω—ã–º –¥–∞–Ω–Ω—ã–º');
      } else {
        toastError('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è', '–ò–º—è –∏ —Ñ–∞–º–∏–ª–∏—è –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã');
      }
    } else if (currentStep === 2) {
      setCurrentStep(3);
      toastSuccess('–ü–æ—á—Ç–∏ –≥–æ—Ç–æ–≤–æ!', '–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–∞–Ω–Ω—ã–µ –∑–∞–∫–∞–∑–∞');
    }
  };

  const handlePrevStep = () => {
    if (currentStep > 1) {
      setCurrentStep(currentStep - 1);
    }
  };

  const handleCreateOrder = async () => {
    if (!validateForm()) {
      toastError('–û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏', '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∏—Å–ø—Ä–∞–≤—å—Ç–µ –æ—à–∏–±–∫–∏ –≤ —Ñ–æ—Ä–º–µ');
      setCurrentStep(1); // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫ –ø–µ—Ä–≤–æ–º—É —à–∞–≥—É –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
      return;
    }

    try {
      const result = await cart.createOrder({
        firstName: billingData.firstName,
        lastName: billingData.lastName,
        phone: billingData.phone,
        email: billingData.email
      });

      if (result.success) {
        toastSuccess(
          '–ó–∞–∫–∞–∑ —Å–æ–∑–¥–∞–Ω!', 
          `–ó–∞–∫–∞–∑ ‚Ññ${result.orderData?.orderNumber} —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω`
        );
        // –ó–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –ø–æ–∫–∞–∑–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
        setTimeout(() => {
          router.push('/order-success');
        }, 1500);
      } else {
        toastError('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞', result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞');
      }
    } catch (error) {
      toastError('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏', '–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É');
    }
  };

  if (items.length === 0) {
    return null; // –ö–æ–º–ø–æ–Ω–µ–Ω—Ç –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–∏—Ç –Ω–∞ –≥–ª–∞–≤–Ω—É—é —á–µ—Ä–µ–∑ useEffect
  }

  return (
    <div className="telegram-app">
      {/* Header */}
      <div className="telegram-header">
        <button 
          onClick={() => currentStep === 1 ? router.back() : handlePrevStep()}
          className="telegram-back-btn"
          disabled={cart.orderLoading}
        >
          <ArrowLeft size={20} />
        </button>
        <h1 className="telegram-header-title">
          {currentStep === 1 && '–õ–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ'}
          {currentStep === 2 && '–ö–æ–Ω—Ç–∞–∫—Ç—ã'}
          {currentStep === 3 && '–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ'}
        </h1>
        <div className="telegram-header-count">
          {currentStep}/3
        </div>
      </div>

      {/* Progress Bar */}
      <div className="checkout-progress-container">
        <div className="checkout-progress-bar">
          {[1, 2, 3].map((step) => (
            <div
              key={step}
              className={`checkout-progress-step ${
                step <= currentStep ? 'active' : ''
              } ${step < currentStep ? 'completed' : ''}`}
            >
              {step < currentStep ? (
                <CheckCircle size={16} />
              ) : (
                <span>{step}</span>
              )}
            </div>
          ))}
        </div>
        <div className="checkout-progress-labels">
          <span className={currentStep >= 1 ? 'active' : ''}>–î–∞–Ω–Ω—ã–µ</span>
          <span className={currentStep >= 2 ? 'active' : ''}>–ö–æ–Ω—Ç–∞–∫—Ç—ã</span>
          <span className={currentStep >= 3 ? 'active' : ''}>–ó–∞–∫–∞–∑</span>
        </div>
      </div>

      {/* Content */}
      <div className="telegram-content">
        {currentStep === 1 && (
          <div className="checkout-step-container">
            <div className="telegram-card checkout-card">
              <div className="checkout-card-header">
                <User className="checkout-card-icon" />
                <div>
                  <h3 className="checkout-card-title">–õ–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</h3>
                  <p className="checkout-card-subtitle">–ö–∞–∫ –∫ –≤–∞–º –æ–±—Ä–∞—â–∞—Ç—å—Å—è?</p>
                </div>
              </div>
              
              <div className="checkout-form-group">
                <label className="telegram-form-label">
                  <User size={16} className="form-label-icon" />
                  –ò–º—è *
                </label>
                <input
                  type="text"
                  value={billingData.firstName}
                  onChange={(e) => handleInputChange('firstName', e.target.value)}
                  className={`telegram-form-input ${formErrors.firstName ? 'error' : ''}`}
                  placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è"
                  disabled={cart.orderLoading}
                />
                {formErrors.firstName && (
                  <div className="form-error-message">
                    {formErrors.firstName}
                  </div>
                )}
              </div>
              
              <div className="checkout-form-group">
                <label className="telegram-form-label">
                  <User size={16} className="form-label-icon" />
                  –§–∞–º–∏–ª–∏—è *
                </label>
                <input
                  type="text"
                  value={billingData.lastName}
                  onChange={(e) => handleInputChange('lastName', e.target.value)}
                  className={`telegram-form-input ${formErrors.lastName ? 'error' : ''}`}
                  placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à—É —Ñ–∞–º–∏–ª–∏—é"
                  disabled={cart.orderLoading}
                />
                {formErrors.lastName && (
                  <div className="form-error-message">
                    {formErrors.lastName}
                  </div>
                )}
              </div>
            </div>
          </div>
        )}

        {currentStep === 2 && (
          <div className="checkout-step-container">
            <div className="telegram-card checkout-card">
              <div className="checkout-card-header">
                <Phone className="checkout-card-icon" />
                <div>
                  <h3 className="checkout-card-title">–ö–æ–Ω—Ç–∞–∫—Ç–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
                  <p className="checkout-card-subtitle">–ö–∞–∫ —Å –≤–∞–º–∏ —Å–≤—è–∑–∞—Ç—å—Å—è? (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</p>
                </div>
              </div>
              
              <div className="checkout-form-group">
                <label className="telegram-form-label">
                  <Phone size={16} className="form-label-icon" />
                  –¢–µ–ª–µ—Ñ–æ–Ω
                </label>
                <input
                  type="tel"
                  value={billingData.phone}
                  onChange={(e) => handleInputChange('phone', e.target.value)}
                  className={`telegram-form-input ${formErrors.phone ? 'error' : ''}`}
                  placeholder="+7 (999) 123-45-67"
                  disabled={cart.orderLoading}
                />
                {formErrors.phone && (
                  <div className="form-error-message">
                    {formErrors.phone}
                  </div>
                )}
              </div>
              
              <div className="checkout-form-group">
                <label className="telegram-form-label">
                  <Mail size={16} className="form-label-icon" />
                  –í–∞—à —Ç–µ–ª–µ–≥—Ä–∞–º
                </label>
                <input
                  type="email"
                  value={billingData.email}
                  onChange={(e) => handleInputChange('email', e.target.value)}
                  className={`telegram-form-input ${formErrors.email ? 'error' : ''}`}
                  placeholder="@username"
                  disabled={cart.orderLoading}
                />
                {formErrors.email && (
                  <div className="form-error-message">
                    {formErrors.email}
                  </div>
                )}
              </div>

              <div className="checkout-info-box">
                <div className="checkout-info-icon">üí°</div>
                <div className="checkout-info-text">
                  –ö–æ–Ω—Ç–∞–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–º–æ–≥—É—Ç –Ω–∞–º —Å–≤—è–∑–∞—Ç—å—Å—è —Å –≤–∞–º–∏ –¥–ª—è —É—Ç–æ—á–Ω–µ–Ω–∏—è –¥–µ—Ç–∞–ª–µ–π –∑–∞–∫–∞–∑–∞
                </div>
              </div>
            </div>
          </div>
        )}

        {currentStep === 3 && (
          <div className="checkout-step-container">
            {/* Customer Info Summary */}
            <div className="telegram-card checkout-card">
              <div className="checkout-card-header">
                <User className="checkout-card-icon" />
                <div>
                  <h3 className="checkout-card-title">–î–∞–Ω–Ω—ã–µ –ø–æ–∫—É–ø–∞—Ç–µ–ª—è</h3>
                  <p className="checkout-card-subtitle">–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å</p>
                </div>
              </div>
              
              <div className="checkout-summary-item">
                <span className="checkout-summary-label">–ò–º—è:</span>
                <span className="checkout-summary-value">{billingData.firstName} {billingData.lastName}</span>
              </div>
              
              {billingData.phone && (
                <div className="checkout-summary-item">
                  <span className="checkout-summary-label">–¢–µ–ª–µ—Ñ–æ–Ω:</span>
                  <span className="checkout-summary-value">{billingData.phone}</span>
                </div>
              )}
              
              {billingData.email && (
                <div className="checkout-summary-item">
                  <span className="checkout-summary-label">–¢–µ–ª–µ–≥—Ä–∞–º:</span>
                  <span className="checkout-summary-value">{billingData.email}</span>
                </div>
              )}
            </div>

            {/* Order Summary */}
            <div className="telegram-card checkout-card">
              <div className="checkout-card-header">
                <ShoppingBag className="checkout-card-icon" />
                <div>
                  <h3 className="checkout-card-title">–í–∞—à –∑–∞–∫–∞–∑</h3>
                  <p className="checkout-card-subtitle">{totalCount} —Ç–æ–≤–∞—Ä–∞ –Ω–∞ —Å—É–º–º—É {formatPrice(totalPrice)}</p>
                </div>
              </div>
              
              <div className="checkout-order-items">
                {items.slice(0, 3).map((item) => (
                  <div key={item.id} className="checkout-order-item">
                    <div className="checkout-order-item-info">
                      <div className="checkout-order-item-name">{item.name}</div>
                      <div className="checkout-order-item-details">
                        {item.qty} —à—Ç. √ó {formatPrice(item.price)}
                      </div>
                    </div>
                    <div className="checkout-order-item-total">
                      {formatPrice(item.price * item.qty)}
                    </div>
                  </div>
                ))}
                
                {items.length > 3 && (
                  <div className="checkout-order-item">
                    <div className="checkout-order-item-info">
                      <div className="checkout-order-item-name">...–∏ –µ—â–µ {items.length - 3} —Ç–æ–≤–∞—Ä–∞</div>
                    </div>
                  </div>
                )}
              </div>

              <div className="checkout-total">
                <div className="checkout-total-label">–ò—Ç–æ–≥–æ –∫ –æ–ø–ª–∞—Ç–µ:</div>
                <div className="checkout-total-amount">{formatPrice(totalPrice)}</div>
              </div>
            </div>
          </div>
        )}
      </div>

      {/* Navigation Buttons */}
      <div className="checkout-navigation">
        {currentStep < 3 ? (
          <button
            onClick={handleNextStep}
            disabled={cart.orderLoading || 
              (currentStep === 1 && (!billingData.firstName.trim() || !billingData.lastName.trim()))}
            className="telegram-primary-btn checkout-next-btn"
          >
            –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å
          </button>
        ) : (
          <button
            onClick={handleCreateOrder}
            disabled={cart.orderLoading}
            className="telegram-primary-btn checkout-order-btn"
          >
            {cart.orderLoading ? (
              <>
                <LoadingSpinner size="small" color="white" />
                <span>–°–æ–∑–¥–∞–µ–º –∑–∞–∫–∞–∑...</span>
              </>
            ) : (
              <>
                <CreditCard size={20} />
                <span>–°–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑ –Ω–∞ {formatPrice(totalPrice)}</span>
              </>
            )}
          </button>
        )}
      </div>
    </div>
  );
}
